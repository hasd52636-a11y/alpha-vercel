## 问题分析

扫码链接无法正常会话的根本原因是：
1. **会话状态差异**：API密钥存储在localStorage中，扫码打开的新会话缺少配置
2. **Hash路由解析**：不同设备对Hash路由格式处理不一致
3. **网络请求时序**：扫码页面资源加载顺序问题
4. **链接活跃状态冲突**：多个设备同时访问导致状态冲突

## 解决方案

### 1. 会话状态优化
- **修改前端代码**：优化API密钥获取逻辑，确保扫码页面自动从环境变量获取
- **实现方式**：修改 `getZhipuApiKey()` 方法，优先使用环境变量
- **文件**：`services/aiService.ts`

### 2. Hash路由兼容性
- **修改链接服务**：确保生成的链接格式在不同设备上兼容
- **实现方式**：优化 `generateLinksForProject()` 方法，确保链接格式正确
- **文件**：`services/linkService.ts`

### 3. 网络请求优化
- **修改前端代码**：优化API调用的错误处理和重试机制
- **实现方式**：增强 `zhipuFetch()` 和 `zhipuStreamFetch()` 方法的错误处理
- **文件**：`services/aiService.ts`

### 4. 链接状态管理
- **修改链接服务**：改进链接活跃状态的管理机制
- **实现方式**：优化 `getNextLinkForProject()` 方法，减少状态冲突
- **文件**：`services/linkService.ts`

## 实施步骤

1. **优化API密钥管理**：修改 `aiService.ts` 中的 `getZhipuApiKey()` 方法
2. **改进链接生成**：优化 `linkService.ts` 中的链接生成逻辑
3. **增强错误处理**：改进API调用的错误处理和重试机制
4. **测试验证**：使用不同设备测试扫码链接的可靠性

## 预期结果

- 扫码链接能够正常打开并建立会话
- 保持现有预览功能不变
- 提高系统在不同网络环境下的稳定性
- 减少链接活跃状态冲突